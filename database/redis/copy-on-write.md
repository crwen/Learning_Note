# 复制

## 复制功能的实现

新版本的 Redis 采用 `PSYNC` 命令来实现复制功能。`PSYNC` 命令有完整重同步（full resynchronization）和部分重同步（partial resynchronization）两种模式。

完整重同步用于处理初次复制的情况，主要步骤如下：

1. 从服务器向主服务器发送 `PSYNC` 命令
2. 收到 `PSYNC` 的主服务器执行 `BGSAVE` 命令，在后台生成 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令
3. 主服务器 `BGSAVE` 命令执行完毕，将 RDB 文件发送给从服务器
4. 从服务器接收并载入 RDB 文件，更新自己数据库状态
5. 主服务器将缓冲区中的写命令发送给从服务器，从服务器执行这些写命令，从而达到主从一致

部分重同步用于处理断线后重复制的情况。部分重同步功能由三个部分构成：

* 服务器运行 ID：每个服务器都由自己的运行 ID，当从服务器初次负值时，主服务器会将自己的运行 ID 发送个从服务器，从服务器会报错这个 ID。当从服务器断线重连后，向主服务器发送之前保存的 ID，来判断是否是进行完整重同步。
* 主服务器的复制积压缓冲区：是一个固定大小的队列。复制积压缓冲区保存着最近传播的写命令，并且记录每个字节相应的复制偏移量。
* 主服务器的复制偏移量和服务器的复制偏移量：主从服务器会维持一个复制偏移量。当从服务器重连时，向主服务器发送复制偏移量 offset，如果复制积压缓冲区中还保持着 offset 之后的数据，进行部分重同步。否则进行执行完整重同步。

## 复制过程

1. 从服务器将主服务器的地址和端口保存到服务器状态的 `masterhost` 和 `masterport` 属性中
2. 从服务器创建连向主服务器的套接字连接。
   * 如果成功连接，从服务器将为会这个套接字关联一个处理复制工作的文件事件处理器。
   * 主服务器 Socket 创建相应的客户端状态
3. 从服务器向主服务器发送 `PIING` 命令，用于 Socket 读写状态是否正常、主服务器能否正常处理命令。
4. 主从服务器根据 `requirepass` 与 `password` 进行身份认证
   * 主服务器没有设置 `requirepass`，从服务器没有设置 `masterauth`，则继续执行命令
   * 主服务器设置了 `requirepass`，从服务器没有设置 `masterauth` ，主服务器返回 `NOAUTH` 错误。
   * 主服务器没有设置 `requirepass`，从服务器设置了 `masterauth`，主服务器返回 `no password is set` 
   * 从服务器通过 `AUTO` 命令发送的密码与主服务器 `requirepass` 相同，继续执行命令。否则返回 `invalid password`
5. 从服务器执行 `REPLCONF listening-port <port>`，向主服务器发送从服务器的监听端口。主服务器会记录咋从服务器对应的客户端状态的 `slave_listening_port` 属性中。
6. 从服务器向主服务器发送 `PSYNC` 命令，进行同步。同步后主从互为客户端
7. 命令传播，将写命令发送给从服务器执行

## 心跳检测

在命令传播阶段，从服务器默认会以每秒一次的频率向主服务器发送命令 `REPLCONF ACK <replication_offset>`

这个命令主要有三个作用：

* 检测主从服务器的网络状态：如果主服务器超过一秒没有收到来自从服务器的 `REPLCONF ACK` 命令，就说明主从之间的连接出现了问题。
* 辅助实现 `min-slaves` 选项：防止主服务器在不安全的情况下执行功能写命令
* 检测命令丢失：传播的命令可能会丢失，使用心跳检测可以可以发送命令的丢失。

## 参考资料

 [黄健宏. Redis 设计与实现 \[M\]. 机械工业出版社，2014.](http://redisbook.com/index.html)


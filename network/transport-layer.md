# 传输层

## TCP

### TCP 报文结构

![](../.gitbook/assets/ryygdsu-38j39r1o9iaeb8w.png)

### 三次握手

![](../.gitbook/assets/1596967549443.png)

* **第一次握手**：客户端发送 SYN 包，其中将 SYN 值位为 1，并随机选择一个起使 ISN 序号 x。该报文段会封装在一个 IP 数据报中，并发送给服务器，然后客户机进入 `SYN-SEND` 状态，等待服务器确认。
* **第二次握手**：服务器收到客户端发送的 SYN 包后，会为该 TCP 连接分配 TCP 缓存和变量，并向客户机 TCP 发送允许连接的报文段（SYN+ACK 报文段）。该报文段中，将 SYN 值为 1，确认好字段 ack 为收到 SYN 包序号 +1\(x + 1\)。同时，服务器随机选择一个序列号 ISN y。然后服务器进入 `SYN-RECV` 状态。
* **第三次握手**：客户端收到服务器的 SYN + ACK 报文后，客户端也要给连接分配缓存和变量。客户机还会向服务器发送一个报文段，来对服务器的允许连接的报文段进行确认。在该包中，确认字段 ack 设置为收到的 SYN + ACK 包中的序列号 + 1 \(y + 1\)。然后客户端进入 `ESTABLISHED`状态。

{% hint style="info" %}
**三次握手的原因**

**第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。**

如果没有第三次握手，客户端发送的连接请求可能会在网络中长时间滞留，以至延误到连接释放以后才到达服务器，但服务器会认为这是一次新的请求，于是会发出确认报文段，同意建立连接，但是客户机不会理睬服务器的确认，也不会向服务器发送数据，造成服务器一直等待客户端发数据。

如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接的确认，不进行第三次握手，因此不会再次打开连接。
{% endhint %}

### 四次挥手

